<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Automation Controller</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      margin-top: 5px;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
    #logArea {
      margin-top: 20px;
      width: 100%;
      height: 300px;
      padding: 10px;
      font-family: monospace;
      background: #f1f1f1;
      border: 1px solid #ccc;
      resize: none;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Automation Control Panel</h2>

  <form id="automationForm">
    <label for="blogURL">Blog URL:</label>
    <input type="text" name="blogURL" id="blogURL" value="https://phpzerotohero.blogspot.com/2022/07/indexed-array-in-php-in-hindi.html" required />

    <label for="ProxyURL">Proxy URL:</label>
    <input type="text" name="ProxyURL" id="ProxyURL" value="http://api.scrape.do?token=de001754420e460597aa9e1984a01e5b5bf586fcb47&url=" required />

    <label for="combinedURL">Combined URL</label>
    <textarea id="combinedURL" name="combinedURL" disabled style="width:100%;font-family:monospace;resize:vertical;min-height:100px;max-height:120px;overflow:auto;"></textarea>

    <label for="browser">Browser:</label>
    <select name="browser" id="browser">
      <option value="random">Random</option>
      <option value="chromium">Chromium</option>
      <option value="firefox">Firefox</option>
      <option value="webkit">Webkit</option>
    </select>

    <label for="openCount">Open Count:</label>
    <input type="number" name="openCount" id="openCount" min="1" max="20" value="3" required />

    <button type="submit">Start Automation</button>
  </form>

  <div id="status">Status: Waiting...</div>

  <label for="logArea">Automation Logs:</label>
  <textarea id="logArea" readonly></textarea>

  <script>
    const form = document.getElementById('automationForm');
    const statusDiv = document.getElementById('status');
    const logArea = document.getElementById('logArea');

    // Set variables for default values
    const blogURL = "https://phpzerotohero.blogspot.com/2022/07/indexed-array-in-php-in-hindi.html";
    const ProxyURL = "http://api.scrape.do?token=de001754420e460597aa9e1984a01e5b5bf586fcb47&url=";

    // Update combined URL field live
    function updateCombinedURL() {
        const blogURLValue = document.getElementById('blogURL').value;
        const proxyURLValue = document.getElementById('ProxyURL').value;
        document.getElementById('combinedURL').value = "https://www.whatismybrowser.com/detect/what-is-my-user-agent/";
    }
    document.getElementById('blogURL').addEventListener('input', updateCombinedURL);
    updateCombinedURL();

    function appendLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      logArea.value += `[${timestamp}] ${message}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    async function checkStatus() {
      try {
        const response = await fetch('/automation-status');
        const data = await response.json();
        if (data.done) {
          statusDiv.innerText = 'Status: Automation completed ✅';
        } else if (data.currentWindow) {
          statusDiv.innerText = `Status: Window ${data.currentWindow} (Remaining ${data.remaining}s)`;
        } else {
          statusDiv.innerText = 'Status: Waiting for next window...';
        }
        setTimeout(checkStatus, 2000);
      } catch (error) {
        console.error('Status check failed:', error);
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      try {
        const res = await fetch('/open-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (result.success) {
          appendLog(`Started automation on: ${result.opened}`);
          appendLog(`Browser: ${result.browser}, Count: ${result.count}`);
          result.waitTimes.forEach((t, i) => appendLog(`→ Window ${i + 1} will run for ~${t}s`));
        } else {
          appendLog(`❌ Failed: ${result.error}`);
        }
      } catch (err) {
        appendLog(`❌ Error: ${err.message}`);
      }

      statusDiv.innerText = 'Status: Running...';
    });

    checkStatus();
  </script>
</body>
</html>
