<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Automation Controller</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				background: #121212;
				color: #ffffff;
				margin: 20px;
			}

			label {
				display: block;
				margin-top: 10px;
				color: #ffffff;
			}

			input,
			select,
			button,
			textarea {
				margin-top: 5px;
				padding: 6px;
				width: 100%;
				box-sizing: border-box;
				background: #1e1e1e;
				color: #ffffff;
				border: 1px solid #444;
				font-size: large;
			}

			button {
				margin-top: 15px;
				background-color: #4caf50;
				color: #ffffff;
				border: none;
				cursor: pointer;
			}

			button:hover {
				background-color: #45a049;
			}

			/* Stop button styling */
			#stopButton {
				background-color: #f44336;
				display: none;
			}

			#stopButton:hover {
				background-color: #d32f2f;
			}

			#status {
				margin-top: 20px;
				font-weight: bold;
				color: #a0ffa0;
			}

			#combinedURL {
				background: #1e1e1e;
				color: #fb8200;
				border: 1px solid #444;
			}

			#blogURL,
			#ProxyURL {
				color: #00ffd2;
			}

			/* Profile logs styles */
			.profile-logs-container {
				display: none;
				margin-top: 20px;
			}

			.profile-logs-grid {
				display: grid;
				gap: 15px;
				margin-top: 15px;
				grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
			}

			.profile-log-item {
				background: #1a1a1a;
				border: 1px solid #444;
				border-radius: 8px;
				padding: 15px;
				min-height: 300px;
				display: flex;
				flex-direction: column;
			}

			.profile-log-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
				padding-bottom: 8px;
				border-bottom: 1px solid #444;
				flex-shrink: 0;
			}

			.profile-log-title {
				font-weight: bold;
				color: #4caf50;
				font-size: 16px;
			}

			.profile-log-status {
				padding: 4px 8px;
				border-radius: 4px;
				font-size: 12px;
				font-weight: bold;
			}

			.profile-log-status.waiting {
				background: #ff9800;
				color: #000;
			}

			.profile-log-status.running {
				background: #4caf50;
				color: #fff;
			}

			.profile-log-status.completed {
				background: #2196f3;
				color: #fff;
			}

			.profile-log-status.error {
				background: #f44336;
				color: #fff;
			}

			.profile-log-area {
				width: 100%;
				height: 200px;
				padding: 10px;
				font-family: monospace;
				background: #000;
				color: #0f0;
				border: 1px solid #333;
				resize: none;
				white-space: pre-wrap;
				font-size: 12px;
				flex: 1;
				min-height: 200px;
			}

			/* Error message styling */
			.error-message {
				color: #ff4444;
				font-weight: bold;
			}

			/* Success message styling */
			.success-message {
				color: #4caf50;
				font-weight: bold;
			}

			/* Warning message styling */
			.warning-message {
				color: #ff9800;
				font-weight: bold;
			}

			/* Hide form during automation */
			.automation-running .form-container {
				display: none;
			}

			.automation-running .profile-logs-container {
				display: block;
			}

			/* Progress indicator */
			.progress-indicator {
				display: none;
				margin: 20px 0;
				padding: 15px;
				background: #1a1a1a;
				border-radius: 8px;
				border: 1px solid #444;
			}

			.progress-bar {
				width: 100%;
				height: 20px;
				background: #333;
				border-radius: 10px;
				overflow: hidden;
				margin: 10px 0;
			}

			.progress-fill {
				height: 100%;
				background: linear-gradient(90deg, #4caf50, #45a049);
				transition: width 0.3s ease;
				width: 0%;
			}

			.progress-text {
				text-align: center;
				font-weight: bold;
				color: #4caf50;
			}

			.automation-running .progress-indicator {
				display: block;
			}

			/* Responsive design for smaller screens */
			@media (max-width: 768px) {
				.profile-logs-grid {
					grid-template-columns: 1fr;
					gap: 10px;
				}

				.profile-log-item {
					min-height: 250px;
					padding: 10px;
				}

				.profile-log-area {
					height: 150px;
					min-height: 150px;
					font-size: 11px;
				}
			}
		</style>
	</head>
	<body>
		<h2>ðŸ§  Automation Control Panel</h2>

		<div class="form-container">
			<form id="automationForm">
				<label for="blogURL">Blog URL:</label>
				<input
					type="text"
					name="blogURL"
					id="blogURL"
					value="https://phpzerotohero.blogspot.com/2022/07/indexed-array-in-php-in-hindi.html"
					required
				/>

				<label for="ProxyURL">Proxy URL:</label>
				<input
					type="text"
					name="ProxyURL"
					id="ProxyURL"
					value="http://api.scrape.do?token=de001754420e460597aa9e1984a01e5b5bf586fcb47&url="
					required
				/>

				<label for="combinedURL">Combined URL</label>
				<textarea
					id="combinedURL"
					name="combinedURL"
					disabled
					style="
						width: 100%;
						font-family: monospace;
						resize: vertical;
						min-height: 100px;
						max-height: 120px;
						overflow: auto;
					"
				></textarea>

				<label for="browser">Browser:</label>
				<select name="browser" id="browser">
					<option value="random">Random</option>
					<option value="chromium">Chromium</option>
					<option value="firefox">Firefox</option>
					<option value="webkit">Webkit</option>
				</select>

				<label for="openCount">Time of Run Automation:</label>
				<input
					type="number"
					name="openCount"
					id="openCount"
					min="1"
					max="20"
					value="3"
					required
				/>

				<label for="profilesAtOnce">Profiles at Once:</label>
				<input
					type="number"
					name="profilesAtOnce"
					id="profilesAtOnce"
					min="1"
					max="10"
					value="2"
					required
				/>

				<label for="timeout">Website Loading Timeout (seconds):</label>
				<input
					type="number"
					name="timeout"
					id="timeout"
					min="10"
					max="120"
					value="30"
					required
				/>
				<small
					style="
						background-color: #ffffff;
						color: #000;
						font-size: 15px;
						font-weight: bold;
					"
					>Recommended: 30 seconds. Increase for slow websites, decrease for fast
					ones.</small
				>

				<label for="minWaitTime">Minimum Wait Time (seconds):</label>
				<input
					type="number"
					name="minWaitTime"
					id="minWaitTime"
					min="10"
					max="120"
					value="45"
					required
				/>
				<small
					style="
						background-color: #ffffff;
						color: #000;
						font-size: 15px;
						font-weight: bold;
					"
					>Recommended: 45 seconds. This is the minimum time each profile will stay on the
					website.</small
				>

				<label for="maxWaitTime">Maximum Wait Time (seconds):</label>
				<input
					type="number"
					name="maxWaitTime"
					id="maxWaitTime"
					min="10"
					max="120"
					value="55"
					required
				/>
				<small
					style="
						background-color: #ffffff;
						color: #000;
						font-size: 15px;
						font-weight: bold;
					"
					>Recommended: 55 seconds. This is the maximum time each profile will stay on the
					website.</small
				>

				<div class="control-buttons">
					<button type="submit" id="startButton">Start Automation</button>
				</div>
			</form>
		</div>

		<!-- Stop button outside the form container -->
		<button
			type="button"
			id="stopButton"
			style="
				display: none;
				margin-top: 15px;
				width: 100%;
				background-color: #f44336;
				color: #ffffff;
				border: none;
				cursor: pointer;
				padding: 6px;
				font-size: large;
			"
		>
			Stop Automation
		</button>

		<!-- Progress indicator -->
		<div class="progress-indicator" id="progressIndicator">
			<div class="progress-text" id="progressText">Progress: 0%</div>
			<div class="progress-bar">
				<div class="progress-fill" id="progressFill"></div>
			</div>
		</div>

		<div id="status">Status: Waiting...</div>

		<!-- Profile logs container -->
		<div class="profile-logs-container" id="profileLogsContainer">
			<h3>ðŸ“Š Automation Logs</h3>
			<div class="profile-logs-grid" id="profileLogsGrid"></div>
		</div>

		<script>
			const form = document.getElementById('automationForm');
			const statusDiv = document.getElementById('status');
			const startButton = document.getElementById('startButton');
			const stopButton = document.getElementById('stopButton');
			const profileLogsContainer = document.getElementById('profileLogsContainer');
			const profileLogsGrid = document.getElementById('profileLogsGrid');
			const progressIndicator = document.getElementById('progressIndicator');
			const progressText = document.getElementById('progressText');
			const progressFill = document.getElementById('progressFill');

			// Set variables for default values
			const blogURL =
				'https://phpzerotohero.blogspot.com/2022/07/indexed-array-in-php-in-hindi.html';
			const ProxyURL =
				'http://api.scrape.do?token=de001754420e460597aa9e1984a01e5b5bf586fcb47&url=';

			// Profile log areas
			let profileLogs = new Map();
			let currentProfilesCount = 0;
			let logUpdateInterval = null;

			// Function to create profile log areas
			function createProfileLogs(profilesCount) {
				profileLogsGrid.innerHTML = '';
				profileLogs.clear();
				currentProfilesCount = profilesCount;

				for (let i = 1; i <= profilesCount; i++) {
					const logItem = document.createElement('div');
					logItem.className = 'profile-log-item';
					logItem.innerHTML = `
						<div class="profile-log-header">
							<div class="profile-log-title">Profile ${i}</div>
							<div class="profile-log-status waiting" id="profileStatus${i}">Waiting</div>
						</div>
						<textarea class="profile-log-area" id="profileLog${i}" readonly></textarea>
					`;
					profileLogsGrid.appendChild(logItem);

					// Store reference to log area
					profileLogs.set(i, document.getElementById(`profileLog${i}`));
				}
			}

			// Function to append log to specific profile
			function appendProfileLog(profileIndex, message) {
				const logArea = profileLogs.get(profileIndex);
				if (logArea) {
					const timestamp = new Date().toLocaleTimeString();
					logArea.value += `[${timestamp}] ${message}\n`;
					logArea.scrollTop = logArea.scrollHeight;
				}
			}

			// Function to update profile status
			function updateProfileStatus(profileIndex, status, className) {
				const statusElement = document.getElementById(`profileStatus${profileIndex}`);
				if (statusElement) {
					statusElement.textContent = status;
					statusElement.className = `profile-log-status ${className}`;
				}
			}

			// Function to fetch and update profile logs
			async function updateProfileLogs() {
				if (currentProfilesCount === 0) return;

				try {
					const response = await fetch('/logs/profiles');
					const data = await response.json();

					if (data.success && data.profileLogs) {
						for (let i = 1; i <= currentProfilesCount; i++) {
							const profileLog = data.profileLogs[i];
							if (profileLog) {
								const logArea = profileLogs.get(i);
								if (logArea) {
									logArea.value = profileLog;
									logArea.scrollTop = logArea.scrollHeight;
								}
							}
						}

						// Update profile statuses
						if (data.success && data.profileStatuses) {
							for (let i = 1; i <= currentProfilesCount; i++) {
								const status = data.profileStatuses[i];
								if (status) {
									let className = 'waiting';
									if (status === 'running') {
										className = 'running';
									} else if (status === 'completed') {
										className = 'completed';
									} else if (status === 'failed') {
										className = 'error';
									}
									updateProfileStatus(i, status, className);
								}
							}
						}
					}
				} catch (error) {
					console.error('Failed to fetch profile logs:', error);
				}
			}

			// Function to start log updates
			function startLogUpdates() {
				if (logUpdateInterval) {
					clearInterval(logUpdateInterval);
				}
				logUpdateInterval = setInterval(updateProfileLogs, 2000);
			}

			// Function to stop log updates
			function stopLogUpdates() {
				if (logUpdateInterval) {
					clearInterval(logUpdateInterval);
					logUpdateInterval = null;
				}
			}

			// Function to enable/disable form during automation
			function setAutomationState(isRunning) {
				if (isRunning) {
					document.body.classList.add('automation-running');
					startButton.style.display = 'none';
					stopButton.style.display = 'block';
					startLogUpdates();
				} else {
					document.body.classList.remove('automation-running');
					startButton.style.display = 'block';
					stopButton.style.display = 'none';
					stopLogUpdates();
				}
			}

			// Update combined URL field live
			function updateCombinedURL() {
				const blogURLValue = document.getElementById('blogURL').value;
				const proxyURLValue = document.getElementById('ProxyURL').value;
				document.getElementById('combinedURL').value =
					proxyURLValue + encodeURIComponent(blogURLValue);
			}
			document.getElementById('blogURL').addEventListener('input', updateCombinedURL);
			updateCombinedURL();

			async function checkStatus() {
				try {
					const response = await fetch('/automation-status');
					const data = await response.json();

					if (data.status === 'completed') {
						statusDiv.innerText = `Status: Automation completed âœ… (${data.completedWindows}/${data.totalWindows} profiles across all cycles)`;
						setAutomationState(false);
					} else if (data.activeWindows > 0) {
						const progressText = `Progress: ${data.progress}% (${data.completedWindows}/${data.totalWindows} profiles)`;
						const activeText = `Active: ${data.activeWindows} profiles`;

						// Show details of active windows with better timing info
						let activeDetails = '';
						if (data.activeWindowDetails && data.activeWindowDetails.length > 0) {
							activeDetails = data.activeWindowDetails
								.map((w) => `P${w.windowIndex}(C${w.cycle}): ${w.remaining}s left`)
								.join(', ');
						}

						statusDiv.innerText = `${progressText} | ${activeText} | ${activeDetails}`;

						// Update progress bar
						progressFill.style.width = `${data.progress}%`;
						progressText.textContent = `Progress: ${data.progress}% (${data.completedWindows}/${data.totalWindows})`;

						setAutomationState(true);
					} else if (data.status === 'idle') {
						statusDiv.innerText = 'Status: Ready to start automation...';
						setAutomationState(false);
					} else {
						statusDiv.innerText = 'Status: Preparing automation cycles...';
						setAutomationState(true);
					}

					setTimeout(checkStatus, 2000);
				} catch (error) {
					console.error('Status check failed:', error);
					statusDiv.innerText = 'Status: Error checking status...';
				}
			}

			// Stop automation button handler
			stopButton.addEventListener('click', async () => {
				try {
					const response = await fetch('/stop-automation', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' }
					});

					const result = await response.json();

					if (result.success) {
						statusDiv.innerText = 'Status: Automation stopped';
						setAutomationState(false);
					} else {
						console.error(`Failed to stop automation: ${result.error}`);
					}
				} catch (err) {
					console.error(`Error stopping automation: ${err.message}`);
				}
			});

			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				const formData = new FormData(form);
				const payload = Object.fromEntries(formData.entries());

				// Get profiles count and create log areas
				const profilesCount = parseInt(payload.profilesAtOnce) || 2;
				createProfileLogs(profilesCount);

				// Immediately set automation state to prevent button flickering
				setAutomationState(true);
				statusDiv.innerText = 'Status: Starting automation...';

				try {
					const res = await fetch('/open-url', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					const result = await res.json();

					if (result.success) {
						// Log to all profile areas initially
						for (let i = 1; i <= profilesCount; i++) {
							appendProfileLog(i, `ðŸš€ Starting Profile ${i}`);
							appendProfileLog(
								i,
								`ðŸ“Š Total Profiles: ${result.cycles * result.profiles} (${
									result.cycles
								} cycles Ã— ${result.profiles} profiles each)`
							);
							appendProfileLog(
								i,
								`â±ï¸ Website Loading Timeout: ${result.timeout} seconds`
							);
							appendProfileLog(
								i,
								`â° Wait Time Range: ${result.minWait} - ${result.maxWait} seconds per profile`
							);
							appendProfileLog(i, `â³ Waiting for automation to start...`);
						}
					} else {
						console.error(`Failed: ${result.error}`);
						// Reset state if automation failed to start
						setAutomationState(false);
						statusDiv.innerText = 'Status: Failed to start automation';
					}
				} catch (err) {
					console.error(`Error: ${err.message}`);
					// Reset state if there was an error
					setAutomationState(false);
					statusDiv.innerText = 'Status: Error starting automation';
				}
			});

			checkStatus();
		</script>
	</body>
</html>
