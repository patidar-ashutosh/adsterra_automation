<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Automation Controller</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				background: #121212;
				color: #ffffff;
				margin: 20px;
			}

			label {
				display: block;
				margin-top: 10px;
				color: #ffffff;
			}

			input,
			select,
			button,
			textarea {
				margin-top: 5px;
				padding: 6px;
				width: 100%;
				box-sizing: border-box;
				background: #1e1e1e;
				color: #ffffff;
				border: 1px solid #444;
				font-size: large;
			}

			button {
				margin-top: 15px;
				background-color: #4caf50;
				color: #ffffff;
				border: none;
				cursor: pointer;
			}

			button:hover {
				background-color: #45a049;
			}

			#status {
				margin-top: 20px;
				font-weight: bold;
				color: #a0ffa0;
			}

			#logArea {
				margin-top: 20px;
				width: 100%;
				height: 300px;
				padding: 10px;
				font-family: monospace;
				background: #000;
				color: #0f0;
				border: 1px solid #444;
				resize: none;
				white-space: pre-wrap;
			}

			#combinedURL {
				background: #1e1e1e;
				color: #fb8200;
				border: 1px solid #444;
			}

			#blogURL,
			#ProxyURL {
				color: #00ffd2;
			}
		</style>
	</head>
	<body>
		<h2>üß† Automation Control Panel</h2>

		<form id="automationForm">
			<label for="blogURL">Blog URL:</label>
			<input
				type="text"
				name="blogURL"
				id="blogURL"
				value="https://phpzerotohero.blogspot.com/2022/07/indexed-array-in-php-in-hindi.html"
				required
			/>

			<label for="ProxyURL">Proxy URL:</label>
			<input
				type="text"
				name="ProxyURL"
				id="ProxyURL"
				value="http://api.scrape.do?token=de001754420e460597aa9e1984a01e5b5bf586fcb47&url="
				required
			/>

			<label for="combinedURL">Combined URL</label>
			<textarea
				id="combinedURL"
				name="combinedURL"
				disabled
				style="
					width: 100%;
					font-family: monospace;
					resize: vertical;
					min-height: 100px;
					max-height: 120px;
					overflow: auto;
				"
			></textarea>

			<label for="browser">Browser:</label>
			<select name="browser" id="browser">
				<option value="random">Random</option>
				<option value="chromium">Chromium</option>
				<option value="firefox">Firefox</option>
				<option value="webkit">Webkit</option>
			</select>

			<label for="openCount">Time of Run Automation:</label>
			<input
				type="number"
				name="openCount"
				id="openCount"
				min="1"
				max="20"
				value="3"
				required
			/>

			<label for="profilesAtOnce">Profiles at Once:</label>
			<input
				type="number"
				name="profilesAtOnce"
				id="profilesAtOnce"
				min="1"
				max="10"
				value="2"
				required
			/>

			<label for="timeout">Website Loading Timeout (seconds):</label>
			<input
				type="number"
				name="timeout"
				id="timeout"
				min="10"
				max="120"
				value="30"
				required
			/>
			<small
				style="background-color: #ffffff; color: #000; font-size: 15px; font-weight: bold"
				>Recommended: 30 seconds. Increase for slow websites, decrease for fast ones.</small
			>

			<button type="submit">Start Automation</button>
		</form>

		<div id="status">Status: Waiting...</div>

		<label for="logArea">Automation Logs:</label>
		<textarea id="logArea" readonly></textarea>

		<script>
			const form = document.getElementById('automationForm');
			const statusDiv = document.getElementById('status');
			const logArea = document.getElementById('logArea');

			// Set variables for default values
			const blogURL =
				'https://phpzerotohero.blogspot.com/2022/07/indexed-array-in-php-in-hindi.html';
			const ProxyURL =
				'http://api.scrape.do?token=de001754420e460597aa9e1984a01e5b5bf586fcb47&url=';

			// Update combined URL field live
			function updateCombinedURL() {
				const blogURLValue = document.getElementById('blogURL').value;
				const proxyURLValue = document.getElementById('ProxyURL').value;
				document.getElementById('combinedURL').value =
					proxyURLValue + encodeURIComponent(blogURLValue);
			}
			document.getElementById('blogURL').addEventListener('input', updateCombinedURL);
			updateCombinedURL();

			function appendLog(message) {
				const timestamp = new Date().toLocaleTimeString();
				logArea.value += `[${timestamp}] ${message}\n`;
				logArea.scrollTop = logArea.scrollHeight;
			}

			async function checkStatus() {
				try {
					const response = await fetch('/automation-status');
					const data = await response.json();

					if (data.status === 'completed') {
						statusDiv.innerText = `Status: Automation completed ‚úÖ (${data.completedWindows}/${data.totalWindows} profiles across all cycles)`;
					} else if (data.activeWindows > 0) {
						const progressText = `Progress: ${data.progress}% (${data.completedWindows}/${data.totalWindows} profiles)`;
						const activeText = `Active: ${data.activeWindows} profiles`;

						// Show details of active windows with better timing info
						let activeDetails = '';
						if (data.activeWindowDetails && data.activeWindowDetails.length > 0) {
							activeDetails = data.activeWindowDetails
								.map((w) => `P${w.windowIndex}(C${w.cycle}): ${w.remaining}s left`)
								.join(', ');
						}

						statusDiv.innerText = `${progressText} | ${activeText} | ${activeDetails}`;
					} else if (data.status === 'idle') {
						statusDiv.innerText = 'Status: Ready to start automation...';
					} else {
						statusDiv.innerText = 'Status: Preparing automation cycles...';
					}

					setTimeout(checkStatus, 2000);
				} catch (error) {
					console.error('Status check failed:', error);
					statusDiv.innerText = 'Status: Error checking status...';
				}
			}

			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				const formData = new FormData(form);
				const payload = Object.fromEntries(formData.entries());

				try {
					const res = await fetch('/open-url', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					const result = await res.json();

					if (result.success) {
						appendLog(`Started automation on: ${result.url}`);
						appendLog(
							`Browser: ${result.browser}, Cycles: ${result.cycles}, Profiles per Cycle: ${result.profiles}`
						);
						appendLog(
							`üìä Total Profiles: ${result.cycles * result.profiles} (${
								result.cycles
							} cycles √ó ${result.profiles} profiles each)`
						);
						appendLog(`‚è±Ô∏è Website Loading Timeout: ${result.timeout} seconds`);
					} else {
						appendLog(`‚ùå Failed: ${result.error}`);
					}
				} catch (err) {
					appendLog(`‚ùå Error: ${err.message}`);
				}

				statusDiv.innerText = 'Status: Running...';
			});

			checkStatus();
		</script>
	</body>
</html>
